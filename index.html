<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Pameks Tekstil - Premium Dark Chart</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    /* Dark Premium Background */
    body { margin: 0; padding: 0; font-family: 'Inter', sans-serif; background-color: #0f172a; overflow: hidden; }
    #chart-container { width: 100vw; height: calc(100vh - 80px); }
    
    .top-panel {
      height: 80px; background: #1e293b; display: flex; align-items: center; 
      justify-content: space-between; padding: 0 30px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3); position: relative; z-index: 100;
    }
    
    .location-btns { display: flex; gap: 10px; }
    /* Dark Search Group */
    .search-group { display: flex; gap: 5px; align-items: center; background: #334155; padding: 5px; border-radius: 30px; border: 1.5px solid #E31E24; }
    .search-select { padding: 8px 10px; border: none; background: transparent; font-weight: 600; color: #f8fafc; cursor: pointer; outline: none; }
    .search-input { padding: 10px 20px; border: none; border-radius: 20px; width: 250px; outline: none; font-size: 14px; background: #1e293b; color: white; }

    .btn { padding: 10px 20px; border: none; border-radius: 25px; cursor: pointer; font-weight: 600; transition: all 0.3s; background: #334155; color: #94a3b8; }
    .btn.active { background: #E31E24; color: white; }

    /* --- DARK MODAL STYLES --- */
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(8px);
      display: none; align-items: center; justify-content: center; z-index: 3000;
    }
    .modal-content {
      background: #1e293b; width: 90%; max-width: 400px; padding: 40px;
      border-radius: 20px; border: 1px solid #334155; color: white;
      box-shadow: 0 25px 50px rgba(0,0,0,0.5);
      position: relative; animation: modalSlideUp 0.3s ease;
    }
    @keyframes modalSlideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    
    .close-modal { position: absolute; top: 20px; right: 20px; border: none; background: none; font-size: 28px; cursor: pointer; color: #94a3b8; }
    .modal-header { border-bottom: 2px solid #334155; padding-bottom: 20px; margin-bottom: 20px; text-align: center; }
    .modal-name { font-size: 20px; font-weight: 700; color: white; margin: 0; }
    .modal-title { font-size: 13px; color: #E31E24; font-weight: 700; text-transform: uppercase; margin-top: 10px; letter-spacing: 0.5px; }
    .modal-item { display: flex; flex-direction: column; gap: 5px; margin-bottom: 20px; }
    .modal-label { font-size: 10px; font-weight: 800; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; }
    .modal-value { font-size: 15px; font-weight: 600; color: #f1f5f9; word-break: break-word; }

    /* Highlight Adjustment */
    .node-highlight-rect, .node-highlight-circle, .node-highlight-path, svg rect[fill="none"][stroke-width] { display: none !important; opacity: 0 !important; }
    .highlighted-node { box-shadow: inset 0 0 0 6px #ffd700, 0 0 30px rgba(255, 215, 0, 0.3) !important; }

    .controls { position: fixed; bottom: 30px; right: 30px; display: flex; flex-direction: column; gap: 10px; z-index: 1000; }
    .control-btn { width: 44px; height: 44px; border-radius: 50%; border: none; background: #1e293b; color: white; font-size: 20px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center; border: 1px solid #334155; }

    #loading { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.1rem; color: white; font-weight: 600; }
    /* Lighter Links for Dark Background */
    .link { stroke: #475569 !important; stroke-width: 2px !important; }
  </style>
</head>
<body>

  <div class="top-panel">
    <div class="location-btns">
      <button id="btn-Istanbul" class="btn active" onclick="changeLocation('Istanbul')">ISTANBUL</button>
      <button id="btn-Malkara" class="btn" onclick="changeLocation('Malkara')">MALKARA</button>
    </div>
    <div class="search-group">
      <select id="searchType" class="search-select">
        <option value="id">Search Person</option>
        <option value="title">Search Title</option>
      </select>
      <input type="text" id="searchInput" class="search-input" placeholder="Search..." list="searchList">
      <datalist id="searchList"></datalist>
    </div>
  </div>

  <div id="modalOverlay" class="modal-overlay" onclick="closeModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
      <button class="close-modal" onclick="closeModal()">×</button>
      <div class="modal-header">
        <p id="mName" class="modal-name"></p>
        <p id="mTitle" class="modal-title"></p>
      </div>
      <div class="modal-item">
        <span class="modal-label">Reports To</span>
        <span id="mManager" class="modal-value"></span>
      </div>
      <div id="m-email-box" class="modal-item">
        <span class="modal-label">Email</span>
        <span id="mEmail" class="modal-value"></span>
      </div>
      <div id="m-phone-box" class="modal-item">
        <span class="modal-label">Phone</span>
        <span id="mPhone" class="modal-value"></span>
      </div>
    </div>
  </div>

  <div class="controls">
    <button class="control-btn" onclick="chart.zoomIn()" title="Zoom In">+</button>
    <button class="control-btn" onclick="chart.zoomOut()" title="Zoom Out">-</button>
    <button class="control-btn" onclick="chart.fit()" title="Fit to Screen">⟲</button>
    <button class="control-btn" onclick="toggleFullScreen()" title="Full Screen">⛶</button>
  </div>

  <div id="loading">Initializing System...</div>
  <div id="chart-container"></div>

  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3-org-chart@3.1.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3-flextree@2.1.2/build/d3-flextree.js"></script>

  <script>
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS53ndrTBAgFEdi_57aoGwMsWukrhbuOaMUpk8haK7cB4Kc_kZVqfCLQ_OQGOWA4W-uc8PU4AMt5i3P/pub?gid=0&single=true&output=csv";
    let allData = [];
    let currentFilteredData = [];
    let chart;

    d3.csv(CSV_URL).then(data => {
      document.getElementById('loading').style.display = 'none';
      allData = data.map(d => ({
        id: d.ID ? d.ID.trim() : "",
        parentId: d.Manager_ID ? d.Manager_ID.trim() : "",
        title: d.Title ? d.Title.trim() : "",
        location: d.Lokasyon ? d.Lokasyon.trim() : "",
        email: d.Email ? d.Email.trim() : "",
        phone: d.Phone ? d.Phone.trim() : ""
      })).filter(d => d.id !== "");
      changeLocation('Istanbul');
    });

    function changeLocation(loc) {
      document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
      document.getElementById('btn-' + loc).classList.add('active');
      document.getElementById('searchInput').value = "";
      closeModal();
      const filtered = allData.filter(d => d.location === loc);
      const idsInLocation = new Set(filtered.map(d => d.id));
      const managers = new Set(filtered.map(d => d.parentId).filter(p => p && idsInLocation.has(p)));
      currentFilteredData = filtered.map(d => ({
        ...d,
        parentId: idsInLocation.has(d.parentId) ? d.parentId : null,
        isManager: managers.has(d.id)
      }));
      updateSearchList();
      renderChart(currentFilteredData);
    }

    function updateSearchList() {
      const type = document.getElementById('searchType').value;
      const list = document.getElementById('searchList');
      list.innerHTML = "";
      const values = [...new Set(currentFilteredData.map(d => type === 'id' ? d.id : d.title))];
      values.forEach(v => {
        const opt = document.createElement('option'); opt.value = v; list.appendChild(opt);
      });
    }

    document.getElementById('searchType').addEventListener('change', updateSearchList);

    document.getElementById('searchInput').addEventListener('input', function(e) {
      const val = e.target.value.trim();
      const type = document.getElementById('searchType').value;
      if (val === "") { renderChart(currentFilteredData); return; }
      const targetNode = currentFilteredData.find(d => (type === 'id' ? d.id : d.title) === val);
      if (targetNode) {
        const focusIds = new Set();
        let current = targetNode;
        while (current) {
          focusIds.add(current.id);
          current = currentFilteredData.find(d => d.id === current.parentId);
        }
        const focusData = currentFilteredData.filter(d => focusIds.has(d.id));
        renderChart(focusData.map(d => ({ ...d, _highlighted: d.id === targetNode.id })));
      }
    });

    window.showModalById = function(nodeId) {
      const d = currentFilteredData.find(p => p.id === nodeId);
      if (!d) return;
      document.getElementById('mName').innerText = d.id;
      document.getElementById('mTitle').innerText = d.title;
      const manager = currentFilteredData.find(p => p.id === d.parentId);
      document.getElementById('mManager').innerText = manager ? manager.id : "Top Management";
      document.getElementById('mEmail').innerText = d.email;
      document.getElementById('m-email-box').style.display = d.email ? 'flex' : 'none';
      document.getElementById('mPhone').innerText = d.phone;
      document.getElementById('m-phone-box').style.display = d.phone ? 'flex' : 'none';
      document.getElementById('modalOverlay').style.display = 'flex';
    };

    function closeModal() { document.getElementById('modalOverlay').style.display = 'none'; }

    function renderChart(data) {
      document.getElementById('chart-container').innerHTML = '';
      chart = new d3.OrgChart()
        .container('#chart-container')
        .data(data)
        .nodeHeight(d => 105)
        .nodeWidth(d => 230)
        .childrenMargin(d => 85)
        .compactMarginBetween(d => 65)
        .nodeContent(function(d) {
          let bgColor, textColor, titleColor, borderRadius;
          // Hierarchy styling adjusted for Dark Mode
          if (d.depth === 0) { 
            bgColor = '#E31E24'; textColor = '#ffffff'; titleColor = '#ffcccc'; borderRadius = '60px'; // CEO
          } else if (d.data.isManager && d.depth === 1) { 
            bgColor = '#002147'; textColor = '#ffffff'; titleColor = '#cbd5e0'; borderRadius = '4px';  // Executives
          } else if (d.data.isManager) { 
            bgColor = '#2C3E50'; textColor = '#ffffff'; titleColor = '#94a3b8'; borderRadius = '15px'; // Managers
          } else { 
            bgColor = '#475569'; textColor = '#f8fafc'; titleColor = '#cbd5e0'; borderRadius = '35px'; // Staff
          }

          const highlightClass = d.data._highlighted ? 'highlighted-node' : '';
          const displayName = d.data.id.split(' & ').join('<br/>');

          return `
            <div class="${highlightClass}" ondblclick="window.showModalById('${d.data.id}')" style="background:${bgColor}; height:100%; padding:12px; border-radius:${borderRadius}; text-align:center; display:flex; flex-direction:column; justify-content:center; box-shadow: 0 4px 15px rgba(0,0,0,0.4); cursor:pointer; border:1px solid rgba(255,255,255,0.1);">
              <div style="font-size:12px; font-weight:700; color:${titleColor}; margin-bottom:6px; text-transform:uppercase; letter-spacing:0.5px; line-height:1.1; pointer-events: none;">${d.data.title}</div>
              <div style="font-size:15px; font-weight:600; color:${textColor}; line-height:1.2; pointer-events: none;">${displayName}</div>
            </div>`;
        })
        .render()
        .expandAll()
        .fit();
    }

    function toggleFullScreen() {
      if (!document.fullscreenElement) document.documentElement.requestFullscreen();
      else document.exitFullscreen();
    }
  </script>
</body>
</html>
