<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pameks Organization Chart</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #0f172a;
            --accent: #2563eb;
            --bg-body: #f8fafc;
            --glass: rgba(255, 255, 255, 0.95);
            --border: #e2e8f0;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-body);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            color: var(--primary);
        }

        /* --- √úST MEN√ú (HEADER) --- */
        .top-bar {
            background: var(--glass);
            border-bottom: 1px solid var(--border);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
            z-index: 100;
        }

        .brand-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .brand-icon {
            width: 40px; height: 40px;
            background: var(--primary);
            color: white;
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-size: 18px;
        }

        .brand-text h1 { font-size: 18px; font-weight: 700; color: #1e293b; letter-spacing: -0.5px; }
        .brand-text p { font-size: 12px; color: #64748b; }

        /* KONTROLLER (Arama & Lokasyon) */
        .controls-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        select {
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: white;
            color: #334155;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: 0.2s;
        }
        select:hover { border-color: var(--accent); }

        .search-wrapper {
            position: relative;
        }
        .search-input {
            padding: 10px 15px 10px 38px;
            width: 250px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: white;
            font-size: 14px;
            transition: 0.3s;
        }
        .search-input:focus { 
            width: 300px; 
            border-color: var(--accent); 
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); 
        }
        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
        }

        .btn-reset {
            padding: 10px;
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            color: #64748b;
            transition: 0.2s;
        }
        .btn-reset:hover { background: #f1f5f9; color: var(--accent); }

        /* --- ANA GRAFƒ∞K ALANI --- */
        #tree-container {
            flex: 1;
            background: radial-gradient(circle at center, #ffffff 0%, #f1f5f9 100%);
            cursor: grab;
        }
        #tree-container:active { cursor: grabbing; }

        /* --- YAN PANEL (SIDEBAR) --- */
        .sidebar {
            position: absolute;
            top: 80px; right: -350px; bottom: 20px;
            width: 320px;
            background: white;
            border-radius: 16px 0 0 16px;
            box-shadow: -5px 0 30px rgba(0,0,0,0.05);
            padding: 30px;
            border: 1px solid var(--border);
            border-right: none;
            transition: right 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            z-index: 90;
            display: flex; flex-direction: column; align-items: center; text-align: center;
        }
        .sidebar.open { right: 0; }
        .sidebar-close { position: absolute; top: 20px; right: 20px; cursor: pointer; color: #cbd5e1; }
        .sidebar-close:hover { color: var(--primary); }

        .profile-img {
            width: 100px; height: 100px;
            border-radius: 50%;
            border: 4px solid white;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            margin-bottom: 15px;
        }
        .profile-name { font-size: 20px; font-weight: 700; color: var(--primary); }
        .profile-title { font-size: 14px; color: #64748b; font-weight: 500; margin-bottom: 25px; }

        .info-card {
            width: 100%;
            background: #f8fafc;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex; justify-content: space-between;
        }
        .lbl { font-size: 12px; color: #94a3b8; font-weight: 600; }
        .val { font-size: 13px; color: #334155; font-weight: 600; }

        /* LOADER */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 1000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .spinner {
            width: 40px; height: 40px;
            border: 3px solid #e2e8f0; border-top-color: var(--accent);
            border-radius: 50%; animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* MOBƒ∞L UYUMLULUK */
        @media (max-width: 768px) {
            .top-bar { flex-direction: column; gap: 15px; align-items: flex-start; }
            .controls-section { width: 100%; flex-wrap: wrap; }
            .search-input { width: 100%; }
        }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <div style="margin-top:10px; font-size:14px; color:#64748b;">Loading Chart...</div>
    </div>

    <div class="top-bar">
        <div class="brand-section">
            <div class="brand-icon"><i class="fas fa-network-wired"></i></div>
            <div class="brand-text">
                <h1>PAMEKS</h1>
                <p>Organization Structure</p>
            </div>
        </div>

        <div class="controls-section">
            <select id="locationSelect" onchange="drawTree()">
                <option value="Istanbul">üè¢ Istanbul HQ</option>
                <option value="Malkara">üè≠ Malkara Plant</option>
            </select>

            <div class="search-wrapper">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-input" id="searchBox" placeholder="Search person..." onkeyup="handleSearch()">
            </div>

            <button class="btn-reset" onclick="resetView()" title="Reset Zoom/View">
                <i class="fas fa-compress-arrows-alt"></i>
            </button>
        </div>
    </div>

    <div id="tree-container"></div>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-close" onclick="closeSidebar()"><i class="fas fa-times"></i></div>
        <img id="sb-img" src="" class="profile-img">
        <div class="profile-name" id="sb-name">-</div>
        <div class="profile-title" id="sb-title">-</div>

        <div class="info-card">
            <span class="lbl">LOCATION</span>
            <span class="val" id="sb-loc">-</span>
        </div>
        <div class="info-card">
            <span class="lbl">MANAGER</span>
            <span class="val" id="sb-manager">-</span>
        </div>
    </div>

    <script>
        const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS53ndrTBAgFEdi_57aoGwMsWukrhbuOaMUpk8haK7cB4Kc_kZVqfCLQ_OQGOWA4W-uc8PU4AMt5i3P/pub?gid=0&single=true&output=csv";
        
        let network = null;
        let allData = [];

        // VERƒ∞Yƒ∞ √áEK
        Papa.parse(CSV_URL, {
            download: true,
            header: true,
            complete: function(results) {
                allData = results.data.filter(d => d.ID && d.ID.trim() !== "");
                drawTree();
                document.getElementById('loader').style.display = 'none';
            },
            error: (err) => alert("Veri y√ºkleme hatasƒ±. ƒ∞nternet baƒülantƒ±nƒ±zƒ± kontrol edin.")
        });

        // AƒûACI √áƒ∞Z
        function drawTree() {
            const container = document.getElementById('tree-container');
            const selectedLoc = document.getElementById('locationSelect').value;
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();

            // 1. Lokasyona g√∂re filtrele
            let locData = allData.filter(item => 
                item.Lokasyon && item.Lokasyon.trim() === selectedLoc
            );

            // 2. Arama Mantƒ±ƒüƒ± (Hiyerar≈üiyi Koruyan)
            let finalData = locData;
            
            if (searchTerm.length > 1) {
                // E≈üle≈üenleri bul
                const matches = locData.filter(p => 
                    p.ID.toLowerCase().includes(searchTerm) || 
                    p.Title.toLowerCase().includes(searchTerm)
                );

                if (matches.length > 0) {
                    const visibleIDs = new Set();

                    // Her e≈üle≈üme i√ßin: Kendisini ve t√ºm y√∂neticilerini (yukarƒ± doƒüru) ekle
                    matches.forEach(match => {
                        let current = match;
                        while(current) {
                            visibleIDs.add(current.ID);
                            // Bir √ºst y√∂neticisini bul
                            if (current.Manager_ID) {
                                current = locData.find(p => p.ID === current.Manager_ID);
                            } else {
                                current = null; // Zincir bitti
                            }
                        }
                    });

                    // Sadece bu ID'leri g√∂ster
                    finalData = locData.filter(item => visibleIDs.has(item.ID));
                } else {
                    // E≈üle≈üme yoksa bo≈ü d√∂nd√ºr (veya uyarƒ± verilebilir)
                    // ≈ûimdilik bo≈ü bƒ±rakƒ±yoruz ki kullanƒ±cƒ± anlasƒ±n
                    finalData = [];
                }
            }

            // 3. Node ve Edge'leri Olu≈ütur
            const nodes = finalData.map(person => {
                // Patron Kontrol√º
                const titleUpper = person.Title ? person.Title.toUpperCase() : "";
                const isBoard = titleUpper.includes("BOARD") || titleUpper.includes("Y√ñNETƒ∞M") || titleUpper.includes("CHAIRMAN");
                
                // Renk ve Boyut Ayarlarƒ±
                let bgColor = isBoard ? "#0f172a" : (person.Manager_ID ? "white" : "#eff6ff");
                let textColor = isBoard ? "white" : "#1e293b";
                let borderColor = isBoard ? "#0f172a" : "#2563eb";
                
                return {
                    id: person.ID,
                    label: `<b>${person.ID}</b>\n${person.Title}`, // ƒ∞sim Kalƒ±n, √únvan ƒ∞nce
                    title: person.Title,
                    image: `https://ui-avatars.com/api/?name=${encodeURIComponent(person.ID)}&background=${isBoard?'0f172a':'2563eb'}&color=fff&size=128`,
                    shape: 'circularImage',
                    size: isBoard ? 50 : 30,
                    borderWidth: 3,
                    color: {
                        background: bgColor,
                        border: borderColor,
                        highlight: { border: "#f59e0b", background: "white" }
                    },
                    font: {
                        multi: 'html',
                        size: isBoard ? 16 : 14,
                        color: "#334155",
                        face: "Inter",
                        vadjust: 5
                    },
                    shadow: { enabled: true, color: 'rgba(0,0,0,0.05)', size: 10, x:0, y:5 }
                };
            });

            const edges = finalData
                .filter(p => p.Manager_ID && finalData.find(m => m.ID === p.Manager_ID))
                .map(p => ({
                    from: p.Manager_ID,
                    to: p.ID,
                    color: { color: "#cbd5e1" },
                    width: 1.5,
                    smooth: { type: 'cubicBezier', forceDirection: 'vertical', roundness: 0.4 }
                }));

            // 4. Vis.js Ayarlarƒ± (Hƒ∞YERAR≈ûƒ∞K D√úZEN)
            const data = { nodes: nodes, edges: edges };
            
            const options = {
                layout: {
                    hierarchical: {
                        enabled: true,
                        direction: 'UD',        // UP to DOWN
                        sortMethod: 'directed', // Y√∂neticiden asta doƒüru
                        levelSeparation: 140,   // Katmanlar arasƒ± bo≈üluk
                        nodeSpacing: 180,       // Ki≈üiler arasƒ± yan bo≈üluk
                        treeSpacing: 200,       // Farklƒ± aƒüa√ßlar arasƒ± bo≈üluk
                        blockShifting: true,
                        edgeMinimization: true,
                        parentCentralization: true,
                        shakeTowards: 'leaves'
                    }
                },
                physics: {
                    enabled: false // Aƒüa√ß yapƒ±sƒ±nda fizik kapalƒ± olursa daha d√ºzg√ºn durur
                },
                interaction: {
                    dragNodes: false, // Aƒüa√ß bozulmasƒ±n diye s√ºr√ºklemeyi kapattƒ±m (istenirse a√ßƒ±labilir)
                    hover: true,
                    tooltipDelay: 200,
                    zoomView: true,
                    dragView: true
                }
            };

            // √áizimi Yap
            if (network) network.destroy();
            network = new vis.Network(container, data, options);

            // Tƒ±klama Olayƒ± (Sidebar)
            network.on("click", function(params) {
                if (params.nodes.length > 0) {
                    const person = allData.find(p => p.ID === params.nodes[0]);
                    openSidebar(person);
                } else {
                    closeSidebar();
                }
            });
        }

        // --- YARDIMCI FONKSƒ∞YONLAR ---
        
        function handleSearch() {
            // Yazarken anlƒ±k arama (biraz gecikmeli performans i√ßin)
            clearTimeout(window.searchTimeout);
            window.searchTimeout = setTimeout(drawTree, 500);
        }

        function resetView() {
            document.getElementById('searchBox').value = "";
            drawTree();
            setTimeout(() => network.fit({animation:true}), 100);
        }

        function openSidebar(person) {
            const sb = document.getElementById('sidebar');
            const imgUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(person.ID)}&background=2563eb&color=fff&size=256`;
            
            document.getElementById('sb-img').src = imgUrl;
            document.getElementById('sb-name').innerText = person.ID;
            document.getElementById('sb-title').innerText = person.Title;
            document.getElementById('sb-loc').innerText = person.Lokasyon;
            document.getElementById('sb-manager').innerText = person.Manager_ID || "Board";
            
            sb.classList.add('open');
        }

        function closeSidebar() {
            document.getElementById('sidebar').classList.remove('open');
        }

    </script>
</body>
</html>
