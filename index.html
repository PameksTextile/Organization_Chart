<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pameks Textile - Corporate Org Chart</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    /* --- CORPORATE COLOR PALETTE --- */
    :root {
      --corp-dark-blue: #263849;   
      --corp-dark-teal: #005f56;   
      --corp-mid-mint: #a7c7b7;    
      --corp-light-mint: #e3ede6;  
      
      --text-dark: #1a202c;
      --text-light: #ffffff;
      --text-muted: #4a5568;
    }

    /* --- GENERAL STYLES --- */
    body { 
      margin: 0; padding: 0; font-family: 'Inter', sans-serif; 
      background-color: var(--corp-light-mint); color: var(--text-dark); 
      overflow: hidden; 
    }
    
    #chart-container { 
      width: 100vw; height: calc(100vh - 80px); 
      background-color: var(--corp-light-mint); 
    }
    
    .top-panel {
      height: 80px; background: #ffffff; display: flex; align-items: center; 
      justify-content: space-between; padding: 0 30px;
      box-shadow: 0 2px 15px rgba(0,0,0,0.08); position: relative; z-index: 100;
    }
    
    .location-btns { display: flex; gap: 10px; }
    
    .search-group { 
      display: flex; gap: 5px; align-items: center; background: #f8fafc; 
      padding: 5px; border-radius: 30px; border: 1.5px solid var(--corp-mid-mint); 
    }
    
    .search-select { 
      padding: 8px 10px; border: none; background: transparent; 
      font-weight: 600; color: var(--text-muted); outline: none; 
    }
    
    .search-input { 
      padding: 10px 20px; border: none; border-radius: 20px; 
      width: 250px; outline: none; font-size: 14px; 
      background: #ffffff; color: var(--text-dark); border: 1px solid #e2e8f0; 
    }

    .btn { 
      padding: 10px 20px; border: 1.5px solid var(--corp-mid-mint); 
      border-radius: 25px; cursor: pointer; font-weight: 600; 
      transition: all 0.2s; background: #ffffff; color: var(--corp-dark-teal); 
    }
    .btn.active { 
      background: var(--corp-dark-teal); color: #ffffff; border-color: var(--corp-dark-teal); 
    }

    /* --- MODAL STİLLERİ --- */
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(38, 56, 73, 0.5); backdrop-filter: blur(4px);
      display: none; align-items: center; justify-content: center; z-index: 3000;
    }
    .modal-content {
      background: #ffffff; width: 90%; max-width: 400px; padding: 40px;
      border-radius: 25px; border: 1px solid #e2e8f0;
      box-shadow: 0 25px 50px rgba(0,0,0,0.15);
      position: relative; animation: modalSlideUp 0.3s ease;
    }
    @keyframes modalSlideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    
    .close-modal { position: absolute; top: 20px; right: 20px; border: none; background: none; font-size: 28px; cursor: pointer; color: var(--text-muted); }
    .modal-header { border-bottom: 2px solid var(--corp-light-mint); padding-bottom: 20px; margin-bottom: 20px; text-align: center; }
    .modal-name { font-size: 22px; font-weight: 700; color: var(--corp-dark-blue); margin: 0; }
    .modal-title { font-size: 14px; color: var(--corp-dark-teal); font-weight: 600; text-transform: uppercase; margin-top: 8px; }

    .modal-item { display: flex; flex-direction: column; gap: 5px; margin-bottom: 15px; }
    .modal-label { font-size: 11px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; }
    .modal-value { font-size: 16px; font-weight: 500; color: var(--text-dark); }

    .highlighted-node { 
      box-shadow: 0 0 0 4px var(--corp-dark-teal), 0 0 30px rgba(0, 95, 86, 0.4) !important; 
    }

    .controls { position: fixed; bottom: 30px; right: 30px; display: flex; flex-direction: column; gap: 10px; z-index: 1000; }
    .control-btn { 
      width: 46px; height: 46px; border-radius: 50%; border: 1px solid #e2e8f0; 
      background: #ffffff; color: var(--corp-dark-blue); font-size: 20px; cursor: pointer; 
      box-shadow: 0 4px 10px rgba(0,0,0,0.08); display: flex; align-items: center; justify-content: center; 
    }

    #loading { 
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
      font-size: 1.2rem; color: var(--corp-dark-blue); font-weight: 600; 
      background: #fff; padding: 20px 40px; border-radius: 50px;
    }
    
    .link { stroke: var(--corp-mid-mint) !important; stroke-width: 2px !important; }
  </style>
</head>
<body>

  <div class="top-panel">
    <div class="location-btns">
      <button id="btn-Istanbul" class="btn active" onclick="changeLocation('Istanbul')">ISTANBUL</button>
      <button id="btn-Malkara" class="btn" onclick="changeLocation('Malkara')">MALKARA</button>
    </div>
    <div class="search-group">
      <select id="searchType" class="search-select">
        <option value="id">Search Name</option>
        <option value="title">Search Title</option>
      </select>
      <input type="text" id="searchInput" class="search-input" placeholder="Search..." list="searchList">
      <datalist id="searchList"></datalist>
    </div>
  </div>

  <div id="modalOverlay" class="modal-overlay" onclick="closeModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
      <button class="close-modal" onclick="closeModal()">×</button>
      <div class="modal-header">
        <p id="mName" class="modal-name"></p>
        <p id="mTitle" class="modal-title"></p>
      </div>
      <div class="modal-item">
        <span class="modal-label">Reports To</span>
        <span id="mManager" class="modal-value"></span>
      </div>
      <div id="m-email-box" class="modal-item">
        <span class="modal-label">Email</span>
        <span id="mEmail" class="modal-value"></span>
      </div>
      <div id="m-phone-box" class="modal-item">
        <span class="modal-label">Ext. / Phone</span>
        <span id="mPhone" class="modal-value"></span>
      </div>
    </div>
  </div>

  <div class="controls">
    <button class="control-btn" onclick="chart.zoomIn()" title="Zoom In">+</button>
    <button class="control-btn" onclick="chart.zoomOut()" title="Zoom Out">-</button>
    <button class="control-btn" onclick="chart.fit()" title="Reset Zoom">⟲</button>
    <button class="control-btn" onclick="toggleFullScreen()" title="Full Screen">⛶</button>
  </div>

  <div id="loading">Initializing System...</div>
  <div id="chart-container"></div>

  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3-org-chart@3.1.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3-flextree@2.1.2/build/d3-flextree.js"></script>

  <script>
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS53ndrTBAgFEdi_57aoGwMsWukrhbuOaMUpk8haK7cB4Kc_kZVqfCLQ_OQGOWA4W-uc8PU4AMt5i3P/pub?gid=0&single=true&output=csv";
    let allData = [];
    let currentFilteredData = [];
    let chart;

    d3.csv(CSV_URL).then(data => {
      document.getElementById('loading').style.display = 'none';
      allData = data.map(d => ({
        id: d.ID ? d.ID.trim() : "",
        parentId: d.Manager_ID ? d.Manager_ID.trim() : "",
        title: d.Title ? d.Title.trim() : "",
        location: d.Lokasyon ? d.Lokasyon.trim() : "",
        email: d.Email ? d.Email.trim() : "",
        phone: d.Phone ? d.Phone.trim() : ""
      })).filter(d => d.id !== "");
      changeLocation('Istanbul');
    });

    function changeLocation(loc) {
      document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
      document.getElementById('btn-' + loc).classList.add('active');
      document.getElementById('searchInput').value = "";
      
      const filtered = allData.filter(d => d.location === loc);
      const idsInLocation = new Set(filtered.map(d => d.id));
      const managers = new Set(filtered.map(d => d.parentId).filter(p => p && idsInLocation.has(p)));
      
      currentFilteredData = filtered.map(d => ({
        ...d,
        parentId: idsInLocation.has(d.parentId) ? d.parentId : null,
        isManager: managers.has(d.id)
      }));
      
      updateSearchList();
      renderChart(currentFilteredData);
    }

    // --- UPDATED SEARCH LIST FUNCTION ---
    function updateSearchList() {
      const type = document.getElementById('searchType').value;
      const list = document.getElementById('searchList');
      list.innerHTML = "";
      
      // Selects unique values based on dropdown selection (id or title)
      const values = [...new Set(currentFilteredData.map(d => type === 'id' ? d.id : d.title))];
      
      values.forEach(v => {
        const opt = document.createElement('option'); 
        opt.value = v; 
        list.appendChild(opt);
      });
    }

    // --- ADDED MISSING EVENT LISTENER ---
    document.getElementById('searchType').addEventListener('change', updateSearchList);

    document.getElementById('searchInput').addEventListener('input', function(e) {
      const val = e.target.value.trim();
      const type = document.getElementById('searchType').value;
      if (val === "") { renderChart(currentFilteredData); return; }
      const targetNode = currentFilteredData.find(d => (type === 'id' ? d.id : d.title) === val);
      if (targetNode) {
        const focusIds = new Set();
        let current = targetNode;
        while (current) {
          focusIds.add(current.id);
          current = currentFilteredData.find(d => d.id === current.parentId);
        }
        const focusData = currentFilteredData.filter(d => focusIds.has(d.id));
        renderChart(focusData.map(d => ({ ...d, _highlighted: d.id === targetNode.id })));
      }
    });

    window.showModalById = function(nodeId) {
      const d = currentFilteredData.find(p => p.id === nodeId);
      if (!d) return;
      document.getElementById('mName').innerText = d.id;
      document.getElementById('mTitle').innerText = d.title;
      const manager = currentFilteredData.find(p => p.id === d.parentId);
      document.getElementById('mManager').innerText = manager ? manager.id : "Top Management";
      document.getElementById('mEmail').innerText = d.email || "-";
      document.getElementById('mPhone').innerText = d.phone || "-";
      document.getElementById('modalOverlay').style.display = 'flex';
    };

    function closeModal() { document.getElementById('modalOverlay').style.display = 'none'; }

    function renderChart(data) {
      document.getElementById('chart-container').innerHTML = '';
      chart = new d3.OrgChart()
        .container('#chart-container')
        .data(data)
        .layout("top")    
        .compact(false)   
        .nodeHeight(d => 100)
        .nodeWidth(d => 230)
        .childrenMargin(d => 60)
        .compactMarginBetween(d => 40)
        .nodeContent(function(d) {
          let bgColor, textColor, titleColor, borderRadius, borderStyle;
          
          if (d.depth === 0) { 
            bgColor = 'var(--corp-dark-blue)'; textColor = '#ffffff'; 
            titleColor = 'var(--corp-mid-mint)'; borderRadius = '50px'; borderStyle = 'none';
          } else if (d.data.isManager && d.depth === 1) { 
            bgColor = 'var(--corp-dark-teal)'; textColor = '#ffffff'; 
            titleColor = 'var(--corp-light-mint)'; borderRadius = '8px'; borderStyle = 'none';
          } else if (d.data.isManager) { 
            bgColor = 'var(--corp-mid-mint)'; textColor = 'var(--corp-dark-blue)'; 
            titleColor = 'var(--corp-dark-teal)'; borderRadius = '15px'; borderStyle = 'none';
          } else { 
            bgColor = '#ffffff'; textColor = 'var(--text-dark)'; 
            titleColor = 'var(--text-muted)'; borderRadius = '30px';
            borderStyle = '2px solid var(--corp-mid-mint)';
          }

          const highlightClass = d.data._highlighted ? 'highlighted-node' : '';
          const displayName = d.data.id.split(' & ').join('<br/>');

          return `
            <div class="${highlightClass}" ondblclick="window.showModalById('${d.data.id}')" 
                 style="background:${bgColor}; height:100%; padding:12px; border-radius:${borderRadius}; 
                        text-align:center; display:flex; flex-direction:column; justify-content:center; 
                        box-shadow: 0 4px 12px rgba(0,0,0,0.06); cursor:pointer; border:${borderStyle};">
              <div style="font-size:11px; font-weight:700; color:${titleColor}; text-transform:uppercase; margin-bottom:4px; line-height:1.1;">${d.data.title}</div>
              <div style="font-size:14px; font-weight:600; color:${textColor}; line-height:1.2;">${displayName}</div>
            </div>`;
        })
        .render()
        .expandAll()
        .fit();
    }

    function toggleFullScreen() {
      if (!document.fullscreenElement) document.documentElement.requestFullscreen();
      else document.exitFullscreen();
    }
  </script>
</body>
</html>
