<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pameks Digital Organization</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #0f172a;
            --accent: #3b82f6;
            --glass: rgba(255, 255, 255, 0.9);
            --bg-gradient: radial-gradient(circle at center, #f8fafc 0%, #cbd5e1 100%);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-gradient);
            height: 100vh;
            overflow: hidden;
            color: var(--primary);
        }

        #network-container { width: 100%; height: 100%; }

        .ui-layer {
            position: absolute; z-index: 10; pointer-events: none;
            width: 100%; height: 100%; top: 0; left: 0;
            display: flex; flex-direction: column; justify-content: space-between; padding: 24px;
        }

        .header-panel {
            pointer-events: auto; background: var(--glass); backdrop-filter: blur(12px);
            padding: 12px 20px; border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05); border: 1px solid rgba(255,255,255,0.6);
            display: inline-flex; align-items: center; gap: 12px;
        }
        .brand-icon {
            width: 36px; height: 36px; background: var(--primary); color: white;
            border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 16px;
        }
        .brand-info h1 { font-size: 15px; font-weight: 700; }
        .brand-info p { font-size: 11px; color: #64748b; font-weight: 500; }

        .bottom-controls {
            pointer-events: auto; align-self: center; background: var(--glass);
            backdrop-filter: blur(16px); padding: 8px 12px; border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08); border: 1px solid rgba(255,255,255,0.8);
            display: flex; gap: 12px; align-items: center; margin-bottom: 20px;
        }

        select, .search-input {
            padding: 10px 14px; border-radius: 10px; border: 1px solid #e2e8f0;
            background: white; font-size: 13px; color: #334155; font-weight: 500;
        }
        .search-input { width: 220px; padding-left: 34px; }
        .search-wrapper { position: relative; }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #94a3b8; font-size: 13px; }
        
        .sidebar {
            pointer-events: auto; position: absolute; right: -350px; top: 24px; bottom: 24px;
            width: 320px; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px);
            border-radius: 24px; box-shadow: -10px 0 40px rgba(0,0,0,0.05);
            padding: 32px; transition: right 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); z-index: 20;
            display: flex; flex-direction: column; align-items: center; text-align: center;
        }
        .sidebar.open { right: 24px; }
        .sidebar-close { position: absolute; top: 20px; right: 20px; cursor: pointer; color: #cbd5e1; }
        
        .profile-avatar {
            width: 80px; height: 80px; border-radius: 50%; background: var(--accent); color: white;
            display: flex; align-items: center; justify-content: center; font-size: 28px; font-weight: 600;
            margin-bottom: 16px; box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
        }
        .profile-name { font-size: 18px; font-weight: 700; color: var(--primary); margin-bottom: 4px; }
        .profile-title { font-size: 13px; color: #64748b; margin-bottom: 24px; }
        .info-row { width: 100%; display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #f1f5f9; }
        .info-label { font-size: 12px; color: #94a3b8; } .info-val { font-size: 13px; color: #334155; font-weight: 600; }

        /* Loader */
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 999; display: flex; align-items: center; justify-content: center; }
        .spinner { width: 40px; height: 40px; border: 3px solid #f1f5f9; border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loader"><div class="spinner"></div></div>

    <div id="network-container"></div>

    <div class="ui-layer">
        <div class="header-panel">
            <div class="brand-icon"><i class="fas fa-sitemap"></i></div>
            <div class="brand-info"><h1>PAMEKS</h1><p>Digital Organization Chart</p></div>
        </div>

        <div class="sidebar" id="sidebar">
            <div class="sidebar-close" onclick="closeSidebar()"><i class="fas fa-times"></i></div>
            <div class="profile-avatar" id="sb-avatar"></div>
            <div class="profile-name" id="sb-name">-</div>
            <div class="profile-title" id="sb-title">-</div>
            <div class="info-row"><span class="info-label">Location</span><span class="info-val" id="sb-loc">-</span></div>
            <div class="info-row"><span class="info-label">Reports To</span><span class="info-val" id="sb-manager">-</span></div>
        </div>

        <div class="bottom-controls">
            <select id="locationSelect" onchange="drawGraph()">
                <option value="Istanbul">Istanbul HQ</option>
                <option value="Malkara">Malkara Plant</option>
            </select>
            <div class="search-wrapper">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-input" id="searchBox" placeholder="Search employee..." onkeyup="handleSearch()">
            </div>
            <button onclick="network.fit({animation:true})" style="border:none; background:none; cursor:pointer; color:#475569;"><i class="fas fa-compress-arrows-alt fa-lg"></i></button>
        </div>
    </div>

    <script>
        const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS53ndrTBAgFEdi_57aoGwMsWukrhbuOaMUpk8haK7cB4Kc_kZVqfCLQ_OQGOWA4W-uc8PU4AMt5i3P/pub?gid=0&single=true&output=csv";
        
        let network = null;
        let allData = [];

        Papa.parse(CSV_URL, {
            download: true, header: true,
            complete: function(results) {
                allData = results.data.filter(d => d.ID && d.ID.trim() !== "");
                drawGraph();
                document.getElementById('loader').style.display = 'none';
            }
        });

        function drawGraph() {
            const container = document.getElementById('network-container');
            const selectedLoc = document.getElementById('locationSelect').value;
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();

            let filteredData = allData.filter(item => item.Lokasyon && item.Lokasyon.trim() === selectedLoc);

            if (searchTerm.length > 1) {
                filteredData = filteredData.filter(item => 
                    item.ID.toLowerCase().includes(searchTerm) || item.Title.toLowerCase().includes(searchTerm)
                );
            }

            // --- İŞTE BURADA DÜZELTME YAPIYORUZ ---
            // Yöneticileri tespit etmek için artık sadece manager_id'ye bakmıyoruz.
            // Ünvanında "Board", "Yönetim", "Chairman" geçenleri ZORLA en tepeye alıyoruz.
            
            const nodes = filteredData.map(person => {
                let level = 2; // Varsayılan çalışan

                const titleUpper = person.Title ? person.Title.toUpperCase() : "";
                
                // 1. KURAL: BOARD OF MANAGEMENT HER ZAMAN EN BÜYÜK (LEVEL 0)
                if (titleUpper.includes("BOARD") || titleUpper.includes("YÖNETİM") || titleUpper.includes("CHAIRMAN")) {
                    level = 0; // The Big Boss
                }
                // 2. KURAL: Eğer bir başkası bu kişiye manager olarak atanmışsa, bu kişi Yöneticidir (LEVEL 1)
                else {
                    const isManager = allData.some(p => p.Manager_ID === person.ID);
                    if (isManager) level = 1;
                }

                // GÖRSEL AYARLAR
                let size, color, fontSize, fontColor;

                if (level === 0) {
                    size = 65; // MERKEZ KOCAMAN
                    color = "#0f172a"; // En koyu (Siyah/Lacivert)
                    fontSize = 24;
                    fontColor = "#0f172a";
                } else if (level === 1) {
                    size = 35; // MÜDÜRLER ORTA
                    color = "#3b82f6"; // Mavi
                    fontSize = 16;
                    fontColor = "#1e293b";
                } else {
                    size = 15; // ÇALIŞANLAR KÜÇÜK
                    color = "#cbd5e1"; // Gri
                    fontSize = 12;
                    fontColor = "#64748b";
                }

                return {
                    id: person.ID,
                    label: `<b>${person.ID}</b>\n${person.Title}`,
                    title: person.Title,
                    shape: 'dot',
                    size: size,
                    color: { background: color, border: "white", highlight: { background: "#f59e0b", border: "white" } },
                    borderWidth: level === 0 ? 6 : 3, // Patronun çerçevesi daha kalın
                    font: { multi: 'html', size: fontSize, color: fontColor, face: "Inter", vadjust: 0 },
                    shadow: { enabled: true, color: 'rgba(0,0,0,0.15)', size: 10, x: 0, y: 5 }
                };
            });

            const edges = filteredData
                .filter(p => p.Manager_ID && filteredData.find(m => m.ID === p.Manager_ID))
                .map(p => ({
                    from: p.Manager_ID,
                    to: p.ID,
                    color: { color: "#cbd5e1", opacity: 0.6 },
                    width: 1
                }));

            const data = { nodes: nodes, edges: edges };

            const options = {
                layout: { improvedLayout: true },
                physics: {
                    enabled: true,
                    barnesHut: {
                        gravitationalConstant: -5000, // Güçlü itme (birbirlerinden ayrılsınlar)
                        centralGravity: 0.5,          // Merkeze çekim
                        springLength: 200,            // Bağlantı uzunluğu
                        springConstant: 0.04,
                        damping: 0.09,
                        avoidOverlap: 1
                    }
                },
                nodes: { shapeProperties: { interpolation: false } },
                interaction: { hover: true, tooltipDelay: 200, zoomView: true }
            };

            if (network) network.destroy();
            network = new vis.Network(container, data, options);

            network.on("click", function(params) {
                if (params.nodes.length > 0) {
                    const person = allData.find(p => p.ID === params.nodes[0]);
                    openSidebar(person);
                } else {
                    closeSidebar();
                }
            });
        }

        function handleSearch() {
            clearTimeout(window.searchTimeout);
            window.searchTimeout = setTimeout(drawGraph, 600);
        }

        function openSidebar(person) {
            const sb = document.getElementById('sidebar');
            const initials = person.ID.split(' ').map(n => n[0]).join('').substring(0,2).toUpperCase();
            document.getElementById('sb-avatar').innerText = initials;
            document.getElementById('sb-name').innerText = person.ID;
            document.getElementById('sb-title').innerText = person.Title;
            document.getElementById('sb-loc').innerText = person.Lokasyon;
            document.getElementById('sb-manager').innerText = person.Manager_ID || "Board";
            sb.classList.add('open');
        }

        function closeSidebar() { document.getElementById('sidebar').classList.remove('open'); }
    </script>
</body>
</html>
