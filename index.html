<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pameks Dijital Organizasyon</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #2563eb; /* Modern Mavi */
            --dark: #0f172a;
            --light: #f8fafc;
            --glass: rgba(255, 255, 255, 0.85);
            --border: rgba(0, 0, 0, 0.08);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }

        body {
            font-family: 'Inter', sans-serif;
            background: #f1f5f9; /* √áok a√ßƒ±k gri, g√∂z yormaz */
            height: 100vh;
            overflow: hidden;
            color: var(--dark);
        }

        /* TAM EKRAN CANVAS */
        #network-container {
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, #ffffff 0%, #f1f5f9 100%);
        }

        /* MODERN UI KATMANLARI */
        .ui-layer {
            position: absolute;
            z-index: 10;
            pointer-events: none; /* Tƒ±klamalar arkaya ge√ßsin */
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
        }

        /* HEADER - SOL √úST */
        .header-panel {
            pointer-events: auto;
            background: var(--glass);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            padding: 16px 24px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.03);
            border: 1px solid rgba(255,255,255,0.5);
            display: inline-flex;
            align-items: center;
            gap: 15px;
            max-width: 400px;
        }

        .brand-icon {
            width: 40px;
            height: 40px;
            background: var(--primary);
            color: white;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .brand-info h1 { font-size: 16px; font-weight: 700; color: #1e293b; }
        .brand-info p { font-size: 12px; color: #64748b; }

        /* ALT KONTROL PANELƒ∞ (Resimdeki gibi) */
        .bottom-controls {
            pointer-events: auto;
            align-self: center;
            background: var(--glass);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            padding: 10px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.08);
            border: 1px solid rgba(255,255,255,0.6);
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            transition: transform 0.3s ease;
        }

        .control-group {
            display: flex;
            align-items: center;
            background: rgba(255,255,255,0.5);
            border-radius: 14px;
            padding: 4px;
            border: 1px solid rgba(0,0,0,0.04);
        }

        .btn-mode {
            padding: 10px 20px;
            border-radius: 12px;
            border: none;
            background: transparent;
            color: #64748b;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-mode.active {
            background: white;
            color: var(--primary);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .btn-mode:hover:not(.active) {
            color: #334155;
            background: rgba(255,255,255,0.8);
        }

        .search-wrapper {
            position: relative;
            margin-left: 10px;
        }

        .search-input {
            padding: 10px 16px 10px 36px;
            border-radius: 12px;
            border: 1px solid transparent;
            background: white;
            font-size: 13px;
            width: 200px;
            transition: all 0.3s;
        }

        .search-input:focus {
            width: 240px;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
            font-size: 14px;
        }

        select {
            padding: 10px 16px;
            border-radius: 12px;
            border: 1px solid transparent;
            background: white;
            font-size: 13px;
            color: #475569;
            cursor: pointer;
        }

        /* SIDEBAR (Detay Paneli) */
        .sidebar {
            pointer-events: auto;
            position: absolute;
            right: -320px;
            top: 20px;
            bottom: 20px;
            width: 300px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px 0 0 20px;
            box-shadow: -10px 0 30px rgba(0,0,0,0.05);
            padding: 30px;
            transition: right 0.4s cubic-bezier(0.19, 1, 0.22, 1);
            z-index: 20;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .sidebar.open { right: 0; }
        
        .sidebar-close {
            position: absolute;
            top: 20px;
            right: 20px;
            cursor: pointer;
            padding: 8px;
            color: #94a3b8;
        }

        .profile-img-large {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin-bottom: 20px;
            box-shadow: 0 8px 20px rgba(37, 99, 235, 0.2);
            border: 4px solid white;
        }

        .profile-name { font-size: 20px; font-weight: 700; color: #1e293b; margin-bottom: 5px; }
        .profile-title { font-size: 14px; color: #64748b; font-weight: 500; margin-bottom: 20px; }
        
        .info-card {
            width: 100%;
            background: #f8fafc;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            text-align: left;
        }
        
        .info-label { font-size: 11px; text-transform: uppercase; color: #94a3b8; letter-spacing: 0.5px; margin-bottom: 4px; }
        .info-value { font-size: 14px; color: #334155; font-weight: 500; }

        /* Loading Overlay */
        #loader {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: white;
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        
        .spinner {
            width: 40px; height: 40px;
            border: 3px solid #e2e8f0;
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Responsive Mobile */
        @media (max-width: 768px) {
            .bottom-controls { flex-wrap: wrap; justify-content: center; width: 90%; }
            .header-panel { padding: 10px 16px; margin-top: 10px; }
            .search-input { width: 150px; }
        }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <div style="margin-top: 15px; font-weight: 500; color: #64748b;">Organizasyon Y√ºkleniyor...</div>
    </div>

    <div id="network-container"></div>

    <div class="ui-layer">
        
        <div class="header-panel">
            <div class="brand-icon"><i class="fas fa-sitemap"></i></div>
            <div class="brand-info">
                <h1>PAMEKS</h1>
                <p>Organizasyon ≈ûemasƒ±</p>
            </div>
        </div>

        <div class="sidebar" id="sidebar">
            <div class="sidebar-close" onclick="closeSidebar()"><i class="fas fa-times"></i></div>
            <img src="" id="sb-img" class="profile-img-large">
            <div class="profile-name" id="sb-name">-</div>
            <div class="profile-title" id="sb-title">-</div>
            
            <div class="info-card">
                <div class="info-label">Lokasyon</div>
                <div class="info-value" id="sb-loc">-</div>
            </div>
            <div class="info-card">
                <div class="info-label">Departman / Grup</div>
                <div class="info-value" id="sb-dept">-</div>
            </div>
             <div class="info-card">
                <div class="info-label">Y√∂netici</div>
                <div class="info-value" id="sb-manager">-</div>
            </div>
        </div>

        <div class="bottom-controls">
            
            <div class="control-group">
                <select id="locationSelect" onchange="filterAndDraw()">
                    <option value="Istanbul">üè¢ Istanbul Merkez</option>
                    <option value="Malkara">üè≠ Malkara Fabrika</option>
                </select>
            </div>

            <div class="control-group">
                <button class="btn-mode active" id="btnNetwork" onclick="setView('network')">
                    <i class="fas fa-project-diagram"></i> Network
                </button>
                <button class="btn-mode" id="btnTree" onclick="setView('tree')">
                    <i class="fas fa-stream"></i> Hiyerar≈üi
                </button>
            </div>

            <div class="control-group search-wrapper">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-input" id="searchBox" placeholder="ƒ∞sim ara..." onkeyup="handleSearch()">
            </div>

            <div class="control-group">
                 <button class="btn-mode" onclick="network.fit({animation:true})"><i class="fas fa-compress-arrows-alt"></i></button>
            </div>

        </div>
    </div>

    <script>
        // --- KONFƒ∞G√úRASYON ---
        const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS53ndrTBAgFEdi_57aoGwMsWukrhbuOaMUpk8haK7cB4Kc_kZVqfCLQ_OQGOWA4W-uc8PU4AMt5i3P/pub?gid=0&single=true&output=csv";
        
        let network = null;
        let allData = [];
        let currentView = 'network'; // 'network' veya 'tree'
        
        // --- VERƒ∞ √áEKME ---
        Papa.parse(CSV_URL, {
            download: true,
            header: true,
            complete: function(results) {
                // Veri temizliƒüi: ID'si bo≈ü olanlarƒ± at
                allData = results.data.filter(d => d.ID && d.ID.trim() !== "");
                console.log("Veri Y√ºklendi:", allData.length);
                
                // Ba≈ülangƒ±√ßta √ßiz
                initVisNetwork();
                document.getElementById('loader').style.display = 'none';
            },
            error: function(err) {
                alert("Veri y√ºklenemedi. Linki kontrol edin.");
                console.error(err);
            }
        });

        // --- VIS.JS BA≈ûLATMA VE √áƒ∞Zƒ∞M ---
        function initVisNetwork() {
            const container = document.getElementById('network-container');
            const data = getFilteredData();
            
            // Genel Ayarlar
            const options = {
                nodes: {
                    shape: 'circularImage',
                    borderWidth: 3,
                    size: 30,
                    color: {
                        border: '#ffffff',
                        background: '#ffffff',
                        highlight: { border: '#2563eb', background: '#ffffff' }
                    },
                    font: { 
                        color: '#334155', 
                        size: 14, 
                        face: 'Inter',
                        multi: true,
                        vadjust: 2
                    },
                    shadow: {
                        enabled: true,
                        color: 'rgba(0,0,0,0.1)',
                        size: 10,
                        x: 0, y: 5
                    }
                },
                edges: {
                    color: { color: '#cbd5e1', highlight: '#2563eb' },
                    width: 1.5,
                    smooth: { type: 'cubicBezier', forceDirection: 'vertical', roundness: 0.4 }
                },
                interaction: {
                    hover: true,
                    tooltipDelay: 200,
                    zoomView: true
                },
                physics: getPhysicsOptions('network') // Ba≈ülangƒ±√ß fiziƒüi
            };

            network = new vis.Network(container, data, options);

            // Tƒ±klama Olayƒ± (Sidebar a√ßmak i√ßin)
            network.on("click", function (params) {
                if (params.nodes.length > 0) {
                    const nodeId = params.nodes[0];
                    const person = allData.find(p => p.ID === nodeId);
                    if(person) openSidebar(person);
                } else {
                    closeSidebar();
                }
            });
        }

        // --- G√ñR√úN√úM DEƒûƒ∞≈ûTƒ∞RME FONKSƒ∞YONU ---
        function setView(mode) {
            currentView = mode;
            
            // Butonlarƒ±n aktifliƒüini g√ºncelle
            document.getElementById('btnNetwork').classList.toggle('active', mode === 'network');
            document.getElementById('btnTree').classList.toggle('active', mode === 'tree');

            const options = {
                physics: getPhysicsOptions(mode),
                layout: getLayoutOptions(mode),
                edges: {
                    smooth: mode === 'network' 
                        ? { type: 'continuous' } 
                        : { type: 'cubicBezier', forceDirection: 'vertical', roundness: 0.4 }
                }
            };
            
            network.setOptions(options);
            
            // Aƒüa√ß modunda her ≈üeyi ekrana sƒ±ƒüdƒ±r
            if(mode === 'tree') {
                setTimeout(() => network.fit({animation: true}), 500);
            }
        }

        // --- Fƒ∞Zƒ∞K VE LAYOUT AYARLARI (Sƒ∞Hƒ∞RLƒ∞ KISIM) ---
        function getPhysicsOptions(mode) {
            if (mode === 'network') {
                // RESƒ∞MDEKƒ∞ Gƒ∞Bƒ∞ ORGANƒ∞K YAPI ƒ∞√áƒ∞N
                return {
                    enabled: true,
                    forceAtlas2Based: {
                        gravitationalConstant: -100, // D√ºƒü√ºmleri birbirinden iter (blobs olu≈üturur)
                        centralGravity: 0.005,      // Merkeze hafif√ße √ßeker
                        springLength: 150,          // Baƒülantƒ± uzunluƒüu
                        springConstant: 0.05,
                        damping: 0.4
                    },
                    solver: 'forceAtlas2Based',
                    stabilization: { iterations: 150 }
                };
            } else {
                // AƒûA√á MODUNDA Fƒ∞Zƒ∞K KAPALI (SABƒ∞T DURMASI ƒ∞√áƒ∞N)
                return {
                    enabled: false
                };
            }
        }

        function getLayoutOptions(mode) {
            if (mode === 'tree') {
                // D√úZENLƒ∞ Hƒ∞YERAR≈ûƒ∞ (√úst √ºste binmeyi engeller)
                return {
                    hierarchical: {
                        enabled: true,
                        direction: 'UD',        // Yukarƒ±dan A≈üaƒüƒ± (Up-Down)
                        sortMethod: 'directed', // Y√∂netici ili≈ükisine g√∂re sƒ±rala
                        levelSeparation: 180,   // Katmanlar arasƒ± bo≈üluk
                        nodeSpacing: 250,       // Yan yana nodlar arasƒ± bo≈üluk (Bunu artƒ±rdƒ±k)
                        treeSpacing: 250,       // Aƒüa√ßlar arasƒ± bo≈üluk
                        blockShifting: true,
                        edgeMinimization: true,
                        parentCentralization: true,
                        shakeTowards: 'leaves'
                    }
                };
            } else {
                // NETWORK MODUNDA Hƒ∞YERAR≈ûƒ∞ KAPALI
                return {
                    hierarchical: { enabled: false }
                };
            }
        }

        // --- VERƒ∞ HAZIRLAMA ---
        function getFilteredData() {
            const selectedLoc = document.getElementById('locationSelect').value;
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            
            // 1. Lokasyon Filtresi
            let filtered = allData.filter(item => 
                item.Lokasyon && item.Lokasyon.trim() === selectedLoc
            );

            // 2. Arama Filtresi
            if (searchTerm.length > 1) {
                // Arama varsa sadece ilgili ki≈üiyi ve y√∂neticilerini/astlarƒ±nƒ± getir (Path finding)
                // ≈ûimdilik basit√ße isme g√∂re filtreleyelim
                filtered = filtered.filter(item => 
                    item.ID.toLowerCase().includes(searchTerm) || 
                    item.Title.toLowerCase().includes(searchTerm)
                );
            }

            const nodes = [];
            const edges = [];

            filtered.forEach(person => {
                // Avatar olu≈ütur (ƒ∞sim ba≈ü harfleriyle)
                const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(person.ID)}&background=random&color=fff&size=128&bold=true`;
                
                // Ba≈ülƒ±klarƒ± (Title) satƒ±rlara b√∂lmek i√ßin (uzun unvanlar i√ßin)
                const label = `<b>${person.ID}</b>\n${person.Title.substring(0, 20)}${person.Title.length>20?'...':''}`;

                nodes.push({
                    id: person.ID,
                    label: label,
                    title: person.Title, // Tooltip
                    image: avatarUrl,
                    // Eƒüer y√∂netici ise biraz daha b√ºy√ºk yap
                    size: person.Manager_ID ? 35 : 50, 
                    font: { multi: 'html' }
                });

                if (person.Manager_ID) {
                    // Y√∂netici de bu listede var mƒ± kontrol et (Filtreleme hatasƒ± olmasƒ±n)
                    const managerExists = filtered.find(m => m.ID === person.Manager_ID);
                    if (managerExists) {
                        edges.push({
                            from: person.Manager_ID,
                            to: person.ID
                        });
                    }
                }
            });

            return { nodes: nodes, edges: edges };
        }

        // --- ARAMA VE G√úNCELLEME ---
        function filterAndDraw() {
            const data = getFilteredData();
            network.setData(data);
            
            // Eƒüer aƒüa√ß modundaysak tekrar d√ºzenle
            if(currentView === 'tree') {
                network.setOptions({ layout: getLayoutOptions('tree') });
            }
        }

        function handleSearch() {
            // Arama yaparken biraz bekle (performans)
            clearTimeout(window.searchTimeout);
            window.searchTimeout = setTimeout(filterAndDraw, 500);
        }

        // --- SIDEBAR ƒ∞≈ûLEMLERƒ∞ ---
        function openSidebar(person) {
            document.getElementById('sb-img').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(person.ID)}&background=2563eb&color=fff&size=256`;
            document.getElementById('sb-name').innerText = person.ID;
            document.getElementById('sb-title').innerText = person.Title;
            document.getElementById('sb-loc').innerText = person.Lokasyon;
            document.getElementById('sb-dept').innerText = "Genel"; // CSV'de departman yoksa genel
            document.getElementById('sb-manager').innerText = person.Manager_ID || "En √úst Y√∂netici";
            
            document.getElementById('sidebar').classList.add('open');
        }

        function closeSidebar() {
            document.getElementById('sidebar').classList.remove('open');
        }

    </script>
</body>
</html>
